

{% extends 'base.html.twig' %}

{% block title %}API Task Manager Login{% endblock %}

{# Load necessary styles and configuration within the stylesheets block #}
{% block stylesheets %}
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body appearance /
        body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a; / Slate-900 /
        }
        .container-center {
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 1rem;
        }
        / Custom focus styles for better visibility */
        input:focus {
            border-color: #4f46e5 !important;
            box-shadow: 0 0 0 1px #4f46e5;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5', // Indigo-600
                        'primary-dark': '#4338ca', // Indigo-700
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
{% endblock %}

{% block body %}
    <div class="container-center">
        <!-- Login Card -->
        <div class="w-full max-w-md bg-white p-8 md:p-10 rounded-xl shadow-2xl space-y-6">
            <h1 class="text-3xl font-bold text-gray-900 text-center">
                API Login
            </h1>
            <p class="text-center text-gray-500">
                Get your JWT token to authorize API requests.
            </p>

            <!-- Login Form -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                    <input type="email" id="email" required value="test@user.email"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-primary focus:border-primary transition duration-150"
                           placeholder="you@example.com">
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password" required value="123"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-primary focus:border-primary transition duration-150"
                           placeholder="********">
                </div>

                <button type="submit" id="loginButton"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition duration-150 ease-in-out">
                    Log In & Get Token
                </button>
                <div id="loadingIndicator" class="hidden text-center text-sm text-primary font-medium mt-2">
                    Processing...
                </div>
            </form>

            <!-- Status and Token Display Area -->
            <div id="statusContainer" class="mt-6 border-t pt-6 hidden">
                <h2 id="statusTitle" class="text-xl font-semibold mb-3"></h2>

                <!-- Token Display -->
                <div id="tokenDisplay" class="hidden space-y-3">
                    <p class="text-sm font-medium text-gray-700">Your JWT Token (use with <code class="text-xs">Authorization: Bearer <token></code>):</p>
                    <div class="relative">
                        <textarea id="tokenTextarea" readonly rows="4"
                                  class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-sm text-gray-800 break-all resize-none"></textarea>
                        <button id="copyButton"
                                class="absolute top-2 right-2 p-2 bg-gray-200 text-gray-700 rounded-lg text-xs hover:bg-gray-300 transition duration-150"
                                title="Copy Token">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5h4m-4 0h4m4 0V3m0 2h-4m4 0v2m4 0h2a2 2 0 012 2v10a2 2 0 01-2 2h-10a2 2 0 01-2-2v-12a2 2 0 012-2h10"></path></svg>
                        </button>
                    </div>
                    <p id="copyMessage" class="text-xs text-green-600 font-medium hidden">Copied!</p>
                </div>

                <!-- Error Display -->
                <div id="errorDisplay" class="hidden p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
                    <p id="errorMessage" class="text-sm font-medium"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8065/login';

        // Element references
        const form = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const loginButton = document.getElementById('loginButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusContainer = document.getElementById('statusContainer');
        const statusTitle = document.getElementById('statusTitle');
        const tokenDisplay = document.getElementById('tokenDisplay');
        const tokenTextarea = document.getElementById('tokenTextarea');
        const errorDisplay = document.getElementById('errorDisplay');
        const errorMessage = document.getElementById('errorMessage');
        const copyButton = document.getElementById('copyButton');
        const copyMessage = document.getElementById('copyMessage');

        // Utility to reset status area
        function resetStatus() {
            statusContainer.classList.add('hidden');
            tokenDisplay.classList.add('hidden');
            errorDisplay.classList.add('hidden');
            copyMessage.classList.add('hidden');
        }

        // Utility to copy text to clipboard
        function copyToClipboard(text) {
            try {
                // Set the text to copy
                tokenTextarea.select();
                tokenTextarea.setSelectionRange(0, 99999); // For mobile devices

                // Use the deprecated but reliable document.execCommand('copy') in iFrames
                const successful = document.execCommand('copy');

                if (successful) {
                    copyMessage.classList.remove('hidden');
                    setTimeout(() => copyMessage.classList.add('hidden'), 2000);
                } else {
                    console.error('Failed to copy text using execCommand');
                    // Fallback using modern API (may fail in iFrames)
                    navigator.clipboard.writeText(text).then(() => {
                        copyMessage.classList.remove('hidden');
                        setTimeout(() => copyMessage.classList.add('hidden'), 2000);
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                    });
                }
            } catch (err) {
                console.error('Error in copying text:', err);
            }
        }

        // Event listener for form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            resetStatus();

            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Authenticating...';
            loadingIndicator.classList.remove('hidden');

            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                let response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/ld+json' // Use the specified accept header
                    },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();

                if (response.ok) {
                    // Success case: The response structure might be { tokens: [{ token: 'jwt-token' }] }
                    const token = result.tokens?.[0]?.token || result.token;

                    statusContainer.classList.remove('hidden');
                    statusTitle.textContent = 'Login Successful!';
                    statusTitle.classList.remove('text-red-600');
                    statusTitle.classList.add('text-green-600');
                    tokenDisplay.classList.remove('hidden');
                    tokenTextarea.value = token || 'Token not found in expected response structure. Response details: ' + JSON.stringify(result);
                } else {
                    // API returned an error (e.g., 401 Unauthorized, 400 Bad Request)
                    statusContainer.classList.remove('hidden');
                    statusTitle.textContent = 'Login Failed';
                    statusTitle.classList.remove('text-green-600');
                    statusTitle.classList.add('text-red-600');
                    errorDisplay.classList.remove('hidden');

                    // Attempt to show a meaningful error message
                    const errorDetail = result.detail || result['hydra:description'] || 'Invalid credentials or unknown error.';
                    errorMessage.textContent = `Error: ${errorDetail}`;
                }

            } catch (networkError) {
                // Network or fetch error (e.g., server offline, CORS issue)
                statusContainer.classList.remove('hidden');
                statusTitle.textContent = 'Connection Error';
                statusTitle.classList.remove('text-green-600');
                statusTitle.classList.add('text-red-600');
                errorDisplay.classList.remove('hidden');
                errorMessage.textContent = `Could not connect to API at ${API_URL}. Check if your backend is running on port 8065.`;
                console.error('Fetch error:', networkError);

            } finally {
                // Reset loading state
                loginButton.disabled = false;
                loginButton.textContent = 'Log In & Get Token';
                loadingIndicator.classList.add('hidden');
            }
        });

        // Event listener for copy button
        copyButton.addEventListener('click', () => {
            copyToClipboard(tokenTextarea.value);
        });

        // Pre-fill the tokenTextarea with the default token value for easy access
        tokenTextarea.value = 'tcp_f1a09f267b7d35f827c744f722ed8edccefc3823bec3a2de9288d29103aeb4f0';
    </script>


{% endblock %}